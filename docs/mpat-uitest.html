<!DOCTYPE html>
<html>

<head>
  <title>moteus Perfomance Analysis Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-size: 14px;
      font-family: system-ui, sans-serif;
      color: #333;
      background: #fcfcfc;
      margin: 0;
      padding: 1 rem;
      padding-bottom: 2.5em;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: auto;
    }
    td, th {
      border: none;
      padding: 0.3rem;
      text-align: left;
    }
    th {
      font-weight: 600;
    }
    td {
      border-top: 1px solid #eee;
    }
    td:nth-child(odd) {
      background-color:#f9fafb;
    }

    td:nth-child(even) {
      background-color: #ffffff;
    }

    th:nth-child(odd) {
      background-color: #f1f5f9;
    }
    th:nth-child(even) {
      background-color: #f5f9fa;
    }

    footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #f1f1f1;
      padding: 10px;
      text-align: center;
      font-size: 0.9em;
      border-top: 1px solid #ccc;
    }

    .pageContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 0.2rem;
    }

    .panelColumn {
      flex: 1 1 300px;
      max-width: 400px;
      min-width: 200px;
      padding: 1em;
    }

    .resultsColumn {
      flex: 2 1 500px;
      min-width: 200px;
      padding: 1em;
    }

    .panelContainer {
      border: 1px solid #ddd;
      border-radius: 3px;
      margin: 0.4em 0;
      background: white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
      /*overflow: hidden;*/
    }

    .panelContent {
      padding: 1rem;
    }

    .configField {
      margin-bottom: 0.75rem;
    }

    .configField:last-child {
      margin-bottom: 0;
    }

    .panelTitle {
      cursor: pointer;
      padding: 0.5rem;
      background:#f7f9fc;
      font-weight: 600;
      border-bottom: 1px solid #eee;
    }

    .resultTable {
      display: inline-block;
      max-width: 100%;
      margin: 1 rem auto;
      background: white;
      border-radius: 5px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
    }

    .multiHeader {
      font-weight: 600;
    }

    .overlayContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.0);
      z-index: 1000;
      outline: 1px dashed red;
      pointer-events: none;
    }

    .overlayBody {
      position: fixed;
      top: 0;
      right: 0;
      width: 300px;
      height: 100%;
      background: white;
      borderLeft: 1px solid #ccc;
      padding: 1rem;
      box-shadow: -2px 0px 8px rgba(0, 0, 0, 0.2);
      pointer-events: auto;
    }

    @media (max-width: 600px) {
      .overlayBody {
        left: 5px;
        right: 5px;
        top: 5px;
        bottom: 5px;
        border-left: none;
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.2);
      }
    }
  </style>
  <script type="importmap">
  {
    "imports": {
      "preact":                 "https://esm.sh/preact@10.26.5",
      "preact/":                "https://esm.sh/preact@10.26.5/",
      "preact/hooks":           "https://esm.sh/preact@10.26.5/hooks",
      "preact/compat":          "https://esm.sh/preact@10.26.5/compat",
      "preact/jsx-runtime":     "https://esm.sh/preact@10.26.5/jsx-runtime",

      "react": "https://esm.sh/preact@10.26.5/compat",
	  "react/": "https://esm.sh/preact@10.26.5/compat/",
	  "react-dom": "https://esm.sh/preact@10.26.5/compat",
      "react-dom/":           "https://esm.sh/preact@10.26.5/compat/",
      "react/jsx-runtime":    "https://esm.sh/preact@10.26.5/jsx-runtime",
      "react/jsx-dev-runtime":"https://esm.sh/preact@10.26.5/jsx-runtime",
      "react-dom/client":     "https://esm.sh/preact@10.26.5/compat",

      "htm": "https://esm.sh/htm@3.1.1",
      "react-select": "https://esm.sh/react-select@5?alias=react:preact/compat,react-dom:preact/compat&deps=preact@10.26.5",
      "react-select/creatable": "https://esm.sh/react-select@5/creatable?alias=react:preact/compat,react-dom:preact/compat&deps=preact@10.26.5"

    }
  }
</script>
  <script>
    // Embed the contents of preact, preact-hooks, and htm.
    // preact 10.26.5 - MIT License: https://github.com/preactjs/preact/blob/main/LICENSE
    // htm 3.1.1 - Apache 2.0 License: https://github.com/developit/htm/blob/master/LICENSE
    //
    // These were generated by:
    //  curl -L https://unpkg.com/preact@10.26.5/dist/preact.umd.js -o preact.umd.js
    //  curl -L https://unpkg.com/preact@10.26.5/hooks/dist/hooks.umd.js -o preact-hooks.umd.js
    //  curl -L https://unpkg.com/htm@3.1.1/dist/htm.umd.js -o htm.umd.js
  </script>
  <script type="module">
    // Copyright 2025 mjbots Robotic Systems, LLC.  info@mjbots.com
    //
    // Licensed under the Apache License, Version 2.0 (the "License");
    // you may not use this file except in compliance with the License.
    // You may obtain a copy of the License at
    //
    //     http://www.apache.org/licenses/LICENSE-2.0
    //
    // Unless required by applicable law or agreed to in writing, software
    // distributed under the License is distributed on an "AS IS" BASIS,
    // WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    // See the License for the specific language governing permissions and
    // limitations under the License.

    import {h, render } from "preact";
    import { useState, useEffect } from "preact/hooks";
    import htm from "htm";
    import Creatable from "react-select/creatable";

    const html = htm.bind(h);

/* ---------- helpers ---------- */
const parseKV = (txt) => {
  const [field, val] = txt.split('=');
  if (!field) return null;  // must have at least a field name
  if (val === undefined) {
    // No '=' found, treat as simple field
    return { field, value: field, label: field };
  }
  // '=' found (val could be empty string)
  return { field, value: field, data: val, label: `${field}=${val}` };
};

// Default values for common config - this defines all available fields
const defaultCommonValues = {
  'controller': 'moteus-x1',
  'controller_cooling': 'none',
  'motor': 'mad8318',
  'motor_cooling': 'none',
  'voltage': '24',
  'velocity': '0',
  'pwm': 'default',
  'supply_power': 'unlimited',
  'supply_current': 'unlimited',
  'time': 'infinity',
  'gear_ratio': '1',
  'ambient_temp': '25',
  'max_controller_temp': 'default',
  'max_motor_temp': 'default',
  'torque': 0,
  'output': 'torque',
  'analysis': "max_torque", // 'max_speed', 'operating_point'
};

// Default values for motor sub-fields
const motorSubFieldDefaults = {
  'motor.kv': '100',
  'motor.r': '0.1',
  'motor.l': '1e-6',
  'motor.mass': '0.1',
  'motor.diameter': '30',
  'motor.type': 'outrunner'
};

/* Field-specific value suggestions - only for constrained fields */
const fieldValueOptions = {
  'controller': [
    'moteus-c1',
    'moteus-r4',
    'moteus-n1',
    'moteus-x1',
    'odrive-micro',
    'odrive-s1',
    'odrive-pro',
  ],
  'controller_cooling': [
    'none',
    'heatspreader',
    '4030sink',
    'fan_5v',
    'fan_12v',
    'max',
  ],
  'motor': [
    'mad8318',
    'mj5208',
    'gbm5208',
    'be8108',
    'model',
    'extrapolated',
  ],
  'motor_cooling': [
    'none',
    'max',
  ],
  'analysis': [
    'max_torque',
    'max_speed',
    'operating_point',
  ],
  'output': [
    'torque',
    'speed',
    'power',
    'controller_temperature',
    'motor_temperature',
    'supply_power',
    'supply_current',
    'phase_current',
    'copper_loss',
    'iron_loss',
    'controller_loss',
    'mechanical_power',
    'efficiency',
  ],
  'motor.type': [
    'outrunner',
    'inrunner'
  ]
};

/* Motor model sub-field configurations */
const motorModelFields = {
  'model': ['kv', 'r', 'l', 'mass'],
  'extrapolated': ['kv', 'mass', 'diameter', 'type']
};

/* Generate dynamic sub-fields based on selected values */
const generateDynamicFields = (selectedValues) => {
  const dynamicFields = [];
  
  selectedValues.forEach(selected => {
    if (selected.field === 'motor' && selected.data) {
      const subFields = motorModelFields[selected.data];
      if (subFields) {
        subFields.forEach(subField => {
          const fullFieldName = `motor.${subField}`;
          dynamicFields.push({
            field: fullFieldName,
            value: fullFieldName,
            label: fullFieldName
          });
        });
      }
    }
  });
  
  return dynamicFields;
};

/* shared base fields for all selectors - derived from default values */
const getBaseFields = (selectedValues) => {
  const staticFields = Object.keys(defaultCommonValues).map(name => ({
    field: name,
    value: name,
    label: name
  }));
  
  const dynamicFields = generateDynamicFields(selectedValues);
  
  return [...staticFields, ...dynamicFields];
};

/* ---------- Reusable ConfigFieldSelector Component ---------- */
function ConfigFieldSelector({
  selected,
  onSelectedChange,
  disabled = false,
  placeholder = "Select or create fields..."
}) {
  const [inputValue, setInputValue] = useState('');

  /* utility â€“ already have this field? */
  const fieldTaken = (f) => selected.some((s) => s.field === f);

  /* Generate dynamic options based on current input */
  const getCurrentOptions = () => {
    const kv = parseKV(inputValue);
    const baseFields = getBaseFields(selected);

    // If no '=' found, show base fields
    if (!kv || kv.data === undefined) {
      return baseFields;
    }

    // If field has constrained values, show all or filtered options
    const fieldOptions = fieldValueOptions[kv.field];
    if (fieldOptions) {
      // Show all options if data is empty (just typed '='), otherwise filter
      const filteredOptions = kv.data === '' ? fieldOptions :
        fieldOptions.filter(value => value.toLowerCase().includes(kv.data.toLowerCase()));

      return filteredOptions.map(value => ({
        field: kv.field,
        value: kv.field,
        data: value,
        label: `${kv.field}=${value}`
      }));
    }

    // For unconstrained fields, return base fields
    return baseFields;
  };

  /* --- callbacks passed to <Creatable> --- */
  const getNewOptionData = (input) =>
    parseKV(input) ?? { field: input, value: input, label: input };

  const isValidNewOption = (input) => {
    const kv = parseKV(input);
    if (!kv) return false;

    // Check if the field is in our allowed list
    const baseFields = getBaseFields(selected);
    const isValidField = baseFields.some(bf => bf.field === kv.field);

    return isValidField && !fieldTaken(kv.field);         // allow only if valid field and unique
  };

  const isOptionDisabled = (opt) => fieldTaken(opt.field);

  /* crucial: actually add the newly-typed chip */
  const onCreateOption = (input) => {
    const kv = parseKV(input);
    if (!kv || fieldTaken(kv.field)) return;    // guard
    onSelectedChange([...selected, kv]);
    setInputValue('');
  };

  const handleInputChange = (input, { action }) => {
    if (action === 'input-change') {
      setInputValue(input);
    }
    return input;
  };

  const handleChange = (newValue) => {
    onSelectedChange(newValue);
    setInputValue(''); // Clear input after selection
  };

  return html`
    <${Creatable}
        isMulti
        isDisabled=${disabled}
        value=${selected}
        onChange=${handleChange}
        placeholder=${placeholder}
        options=${getCurrentOptions()}
        getNewOptionData=${getNewOptionData}
        isValidNewOption=${isValidNewOption}
        onCreateOption=${onCreateOption}
        isOptionDisabled=${isOptionDisabled}
        formatCreateLabel=${(v) => `add ${v}`}
        onInputChange=${handleInputChange}
        inputValue=${inputValue}
      />
  `;
}

/* ---------- Panel Components ---------- */
function CommonConfigPanel({ selected, onSelectedChange }) {
  return html`
    <div class="panelContainer">
      <div class="panelTitle">Common Config</div>
      <div class="panelContent">
        <${ConfigFieldSelector}
          selected=${selected}
          onSelectedChange=${onSelectedChange}
          placeholder="Add common configuration..."
        />
      </div>
    </div>
  `;
}

function AxisPanel({ axisNumber, configs, onConfigsChange }) {
  const handleConfigChange = (index, newValue) => {
    let newConfigs = [...configs];
    newConfigs[index] = newValue;

    // If this is the last (empty) field and user added something, add a new empty field
    if (index === configs.length - 1 && newValue.length > 0) {
      newConfigs.push([]);
    }

    // Remove empty fields that are not the last one
    newConfigs = newConfigs.filter((config, i) => {
      // Keep the last field (even if empty) and any non-empty fields
      return i === newConfigs.length - 1 || config.length > 0;
    });

    // Ensure we always have at least one field (empty if needed)
    if (newConfigs.length === 0) {
      newConfigs = [[]];
    }

    onConfigsChange(newConfigs);
  };

  return html`
    <div class="panelContainer">
      <div class="panelTitle">Axis ${axisNumber}</div>
      <div class="panelContent">
        ${configs.map((config, index) => html`
          <div key=${index} class="configField">
            <${ConfigFieldSelector}
              selected=${config}
              onSelectedChange=${(newValue) => handleConfigChange(index, newValue)}
              placeholder=${index === configs.length - 1 ? `Add new axis ${axisNumber} configuration...` : `Axis ${axisNumber} configuration...`}
            />
          </div>
        `)}
      </div>
    </div>
  `;
}

/* ---------- Main App Component ---------- */
function App() {
  const [commonConfig, setCommonConfig] = useState(
    Object.entries(defaultCommonValues).map(([field, value]) => ({
      field,
      value: field,
      data: value,
      label: `${field}=${value}`
    }))
  );
  const [axisConfigs, setAxisConfigs] = useState([[[]]]);  // Start with one axis with one empty config

  const handleAxisConfigChange = (axisIndex, newConfigs) => {
    let newAxisConfigs = [...axisConfigs];
    newAxisConfigs[axisIndex] = newConfigs;

    // If this is the last axis and it has any content, add a new empty axis
    if (axisIndex === axisConfigs.length - 1 && hasAnyContent(newConfigs)) {
      newAxisConfigs.push([[]]);  // Add new axis with one empty config
    }

    // Remove empty axes that are not the last one
    newAxisConfigs = newAxisConfigs.filter((configs, i) => {
      // Keep the last axis (even if empty) and any non-empty axes
      return i === newAxisConfigs.length - 1 || hasAnyContent(configs);
    });

    // Ensure we always have at least one axis (empty if needed)
    if (newAxisConfigs.length === 0) {
      newAxisConfigs = [[[]]];  // One axis with one empty config
    }

    setAxisConfigs(newAxisConfigs);
  };

  // Helper function to check if any config in an axis has content
  const hasAnyContent = (configs) => {
    return configs.some(config => config.length > 0);
  };

  /* optional: watch state while testing */
  useEffect(() => {
    console.log('Common Config:', commonConfig);
    console.log('Axis Configs:', axisConfigs);
  }, [commonConfig, axisConfigs]);

  return html`
    <div class="pageContainer">
      <div class="panelColumn">
        <${CommonConfigPanel}
          selected=${commonConfig}
          onSelectedChange=${setCommonConfig}
        />
        ${axisConfigs.map((configs, axisIndex) => html`
          <${AxisPanel}
            key=${axisIndex}
            axisNumber=${axisIndex + 1}
            configs=${configs}
            onConfigsChange=${(newConfigs) => handleAxisConfigChange(axisIndex, newConfigs)}
          />
        `)}
      </div>
    </div>
  `;
}

render(html`<${App} />`, document.body);
  </script>
</head>

</html>
